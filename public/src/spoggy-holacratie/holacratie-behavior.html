<script>
/* @polymerMixin */
var HolacratieBehaviorMixin = Polymer.dedupingMixin(function(superClass){
  return class HolacratieBehavior extends superClass {
    constructor() {
      super();
      console.log("holacratie-behavior")
    }
    static get properties() {
      return {


      };
    }

    _debug(){
      console.log("url=", this.url);
      console.log("definition=", this.definition);
      console.log("holaroot=", this.holaroot);
    }
    _loadModule(){
      console.log("_loadModule")
      console.log(this.name,this.url, this.definition)
      var app = this;
      app.fields = [];
      var RDFS =  $rdf.Namespace('http://www.w3.org/2000/01/rdf-schema#');
      var RDF =  $rdf.Namespace("http://www.w3.org/1999/02/22-rdf-syntax-ns#");
      var OWL = $rdf.Namespace("http://www.w3.org/2002/07/owl#");
      this.fileclient = new SolidFileClient();
      this.fileclient.fetchAndParse(this.definition, 'text/turtle').then(
        graph => {
          console.log(graph)
          console.log(graph.statements)
          //recherche du module dÃ©finit dans ce fichier
          app.root = graph.any(null, RDF('type'), OWL('Ontology'));
          console.log("root ", app.root)
          app.moduleSubject = graph.any(app.root, RDFS('isDefinedBy'));
          console.log("moduleSubject ",app.moduleSubject)

          let moduleFields = graph.match(app.moduleSubject,null,null);
          return moduleFields;
        },
        err => console.log(err)
      ).then(
        moduleFields =>{
          console.log(moduleFields)
          while (moduleFields.length >0){
            var f = moduleFields.pop();
            console.log(f)
            console.log(localname(f.subject),localname(f.predicate),localname(f.object))
            var field = {}
            console.log(field)
            field.statement = f;
            if (localname(f.predicate) == "has"){
              console.log("has")
              field.name = localname(f.object)
              field.type = "input"
            }else{
              console.log("else", localname(f.predicate) )
              field.type = localname(f.predicate)
              field.name = localname(f.object)
            }
            console.log(field)
            app.push("fields", field)
          }
          console.log(app.fields)
        }
        ,err => {console.log(err)}
      )
    }


    _loadSchema(){
      var app = this;
      //  console.log(this.type)
      //  console.log(this.holaroot)
      var url = this.holaroot;
      //  var urlSchema = url+"Schema/";
      this.fileclient = new SolidFileClient();
      var RDF =  $rdf.Namespace("http://www.w3.org/1999/02/22-rdf-syntax-ns#");
      var FOAF =  $rdf.Namespace("http://xmlns.com/foaf/0.1/");
      var SPACE =  $rdf.Namespace("http://www.w3.org/ns/pim/space#");
      var ACL =  $rdf.Namespace("http://www.w3.org/ns/auth/acl#");
      var LDP =  $rdf.Namespace("http://www.w3.org/ns/ldp#>");
      var STAT =  $rdf.Namespace('http://www.w3.org/ns/posix/stat#');
      var RDFS =  $rdf.Namespace('http://www.w3.org/2000/01/rdf-schema#');
      var store = $rdf.graph();
      var fetcher = new $rdf.Fetcher(store);


      this.fileclient.readFolder( url ).then( folder => {
        if(!folder) console.log(this.fileclient.err)
        else console.log(`Read ${folder.name}, it has ${folder.files.length} files.`,folder);
        this.folder = folder;
        console.log(app.defs)
        app.defs = [];
        folder.files.forEach(function (file){
          console.log("chargement ", file.name)

          fetcher.load(file.url).then(response => {
            console.log("loaded :",file.url)
            console.log(store.statements)
            /*const defs = store.any(null, RDFS('isDefinedBy'), null);
            console.log(defs)*/
            const defs = store.match(null, RDFS('isDefinedBy'), null);
            console.log("DEFS ",defs)
            return defs
          }, rejected =>{
            console.log(rejected)
          }
        ).then(
          defs =>{
            //  console.log(response.responseText)

            while (defs.length >0){
              var def = defs.pop();
              var d = {}
              d.name = localname(def.subject)
              d.url = def.subject.value;
              d.definition = def.object.value;
              console.log(d.name, d.url, d.definition, defs.length);
              app.push("defs", d)
            }
            console.log(app.defs)
          },
          err=>{console.log("err :",err)}
        )



        /*.then(defs =>{
        console.log("DEFS : ", defs)
        var props = [];
        defs.forEach(function(d){
        var def = d.object.value;

        console.log(def)
        var propsTemp = store.match($rdf.sym(def), null, null);
        console.log("propsTemp ",propsTemp)
        props.push(propsTemp)


      })
      console.log("props ",props)
      //return props

      var res = {defs: defs, props: props}
      console.log("res ",res)
      return res;
    },
    err => {console.log("ERR :", err)}
  )
  .then(
  result => {
  console.log("RESULT : ", result)
  return result;
},
pasResult =>{
console.log("ERREUR : ",pasResult)
}).then(
final => {
console.log("ok")
console.log(final)
app.push("defs", final.defs)
app.push("props", final.props)

},
err =>{console.log("BAD ERR :",err)}
)*/


})

})
}
_creer(){
  console.log("url",this.url)
  console.log("fields 2",this.fields)
  var fields = this.fields
  console.log("TEST if file exist -> create or update");
  var nom = "unknown"
  for (var i = 0; i < fields.length; i++){
    if (fields[i].name == "Nom"){
      nom = fields[i].value.split(' ').join('_');
    }
  }
  var newFile = this.url+'/'+nom+".ttl";
  console.log(newFile)

  var content = this.createContent(this.url, this.fields)

  var contentType = 'text/turtle';
  this.fileclient = new SolidFileClient();
  var realfile = this.fileclient.createFile(newFile,contentType,content).then(success => {
    console.log(success)
    console.log(`Created file ${newFile}.`);
    console.log(this.fileclient)
  },
  err => console.log(err) )
  .then(
    created =>{console.log("created", created)},
    err => {console.log(err)}
  )

}

createContent(url, fields){
  var holaroot = this.holaroot;
  console.log(holaroot)
  var content = '@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#>.\n';
  content += '@prefix hol: <https://holacratie.solid.community/public/holacratie/>.\n';
  content +='@prefix foaf: <http://xmlns.com/foaf/0.1/>.\n\n';

  for (var i = 0; i < fields.length; i++){

    if (fields[i].name == "Nom"){
      content +='<> rdfs:label "'+fields[i].value+'". \n';
    }
    if (fields[i].name == "Description"){
      //description = fields[i].value
      content +='<> rdfs:comment "'+fields[i].value+'". \n';
    }
    var pred = fields[i].name[0].toLowerCase() + fields[i].name.slice(1);
    content +='<> hol:'+pred+' "'+fields[i].value+'". \n';

  }
  console.log(content)
  return content;
}


_loadListe(){
  var app = this;
  console.log("url=", this.url);
  console.log("definition=", this.definition);
  console.log("holaroot=", this.holaroot);
  this.fileclient = new SolidFileClient();
  var url = this.url;
  if (url.substr(-1) != '/') url += '/';
  console.log("fileclient reads",url)
  this.fileclient.readFolder( url ).then( folder => {
    if(!folder) console.log(this.fileclient.err)
    else console.log(`Read ${folder.name}, it has ${folder.files.length} files.`,folder);
    console.log("fichiers",folder.files)
    app.files = folder.files;
    app.subfolders = folder.folders;
    console.log("gestion des sous dossiers?",folder.folders)
    console.log("app.files",app.files)
    console.log("app.subfolders",app.subfolders)
  })
}


_showdetail(){
  console.log(this.type)
  console.log(this.holaroot)
}

_sort(val) {
  console.log(val)
  switch(val) {
    case 'label':
    return function(a, b) {
      if (a.label === b.label) return 0;
      return a.label < b.label ? -1 : 1;
    };
    case 'statut':
    return function(a, b) {
      if (a.statut === b.statut) return 0;
      return a.statut < b.statut ? -1 : 1;
    };
    case 'priorite':
    return function(a, b) {
      if (a.priorite === b.priorite) return 0;
      return a.priorite < b.priorite ? -1 : 1;
    };
    case 'categorie':
    return function(a, b) {
      if (a.categorie === b.categorie) return 0;
      return a.categorie < b.categorie ? -1 : 1;
    };
    case 'mtime':
    return function(a, b) {
      if (a.mtime === b.mtime) return 0;
      return a.mtime < b.mtime ? -1 : 1;
    };
    case 'email_provider':
    var regex = /@(.*)/;
    return function(a, b) {
      var a_provider = a.email.match(regex)[1];
      var b_provider = b.email.match(regex)[1];
      if (a_provider == b_provider) {
        if (a.email === b.email) return 0;
        return a.email < b.email ? -1 : 1;
      }
      return a_provider < b_provider ? -1 : 1;
    };
  }
}


}
});
</script>
